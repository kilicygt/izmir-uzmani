---
import Layout from '../layouts/Layout.astro';
import db from '../lib/db';

// Fetch posts from Turso
const result = await db.execute('SELECT * FROM posts ORDER BY created_at DESC');
const posts = result.rows as any[];

const featuredPosts = posts.slice(0, 3);
const latestPosts = posts.slice(0, 8);

// Fetch event posts for the slider
const eventPostsFromDb = posts.filter(p => p.category === 'Etkinlikler');

// Mock events if needed
const mockEvents = [
    { id: 'mock1', title: 'İzmir Filarmoni Konseri', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event1/400/600', created_at: '2026-01-15', slug: 'izmir-filarmoni-konseri' },
    { id: 'mock2', title: 'Uluslararası Fuar', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event2/400/600', created_at: '2026-01-18', slug: 'uluslararasi-fuar' },
    { id: 'mock3', title: 'Modern Sanat Sergisi', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event3/400/600', created_at: '2026-01-20', slug: 'sanat-sergisi' },
    { id: 'mock4', title: 'Caz Festivali 2026', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event4/400/600', created_at: '2026-01-22', slug: 'caz-festivali' },
    { id: 'mock5', title: 'Tiyatro: Hamlet', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event5/400/600', created_at: '2026-01-25', slug: 'tiyatro-hamlet' },
];

const eventPosts = eventPostsFromDb.length >= 5 ? eventPostsFromDb : [...eventPostsFromDb, ...mockEvents].slice(0, 10);
---

<Layout title="İzmir Uzmanı - Şehri Keşfet">
	<!-- Hero Slider -->
    <section class="max-w-[1400px] mx-auto pt-6 pb-8 px-4">
        <div id="hero-slider" class="flex gap-6 overflow-x-auto snap-x snap-mandatory pb-6 no-scrollbar scroll-smooth">
            {featuredPosts.length > 0 ? featuredPosts.map((post) => (
                <div class="snap-center shrink-0 w-full relative rounded-card overflow-hidden shadow-xl group h-[50vh] md:h-[60vh]">
                    <img src={post.image || `https://picsum.photos/seed/${post.id}/1200/800`} alt={post.title} class="w-full h-full object-cover group-hover:scale-105 transition duration-700" />
                    <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-8 md:p-12 text-white">
                        <span class="inline-block px-4 py-1.5 bg-primary rounded-full text-xs font-bold uppercase tracking-wider mb-4 shadow-lg">{post.category}</span>
                        <h2 class="text-2xl md:text-5xl font-bold leading-tight mb-4 text-white max-w-4xl">{post.title}</h2>
                        <p class="text-white/90 line-clamp-2 md:text-xl mb-8 max-w-2xl">{post.excerpt}</p>
                         <a href={`/blog/${post.slug}`} class="inline-block px-8 py-3 bg-white text-dark rounded-btn font-bold hover:bg-primary hover:text-white transition shadow-lg transform active:scale-95">Devamını Oku</a>
                    </div>
                </div>
            )) : (
                 <div class="w-full h-[50vh] bg-gray-100 rounded-card flex items-center justify-center text-gray-400">
                    Öne çıkan içerik yok.
                 </div>
            )}
        </div>
    </section>

    <!-- Main Content & Sidebar Layout -->
    <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-12">
        
        <!-- Left: Latest Posts -->
        <main class="w-full lg:w-3/4">
            <h2 class="text-3xl font-bold text-dark mb-8 flex items-center gap-3">
                <span class="w-2 h-8 bg-primary rounded-full"></span>
                Son Yazılar
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {latestPosts.length > 0 ? latestPosts.map((post) => (
                    <article class="bg-white rounded-card overflow-hidden shadow-lg hover:shadow-2xl transition duration-300 group flex flex-col h-full border border-gray-50">
                        <div class="relative overflow-hidden h-48 shrink-0">
                             <img src={post.image || `https://picsum.photos/seed/${post.id}/800/600`} alt={post.title} class="w-full h-full object-cover group-hover:scale-110 transition duration-700" />
                             <div class="absolute top-4 left-4">
                                 <span class="px-2 py-1 bg-white/90 backdrop-blur-sm rounded-full text-[10px] font-bold text-primary shadow-sm uppercase">{post.category}</span>
                             </div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-grow">
                            <div class="flex items-center gap-2 mb-2 text-[10px] text-gray-400 uppercase tracking-widest font-semibold">
                                 <span>{new Date(post.created_at).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                            </div>
                            <a href={`/blog/${post.slug}`} class="block group-hover:text-primary transition">
                                <h3 class="text-lg font-bold text-dark mb-2 leading-tight line-clamp-2">{post.title}</h3>
                            </a>
                            <p class="text-gray-500 line-clamp-3 mb-4 leading-relaxed flex-grow text-xs">{post.excerpt}</p>
                            <div class="mt-auto">
                                <a href={`/blog/${post.slug}`} class="inline-flex items-center gap-2 text-primary font-bold hover:underline text-sm">
                                    Devamını Oku
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                </a>
                            </div>
                        </div>
                    </article>
                )) : (
                    <div class="col-span-full py-12 text-center text-gray-500">
                        Henüz yazı bulunmuyor.
                    </div>
                )}
            </div>
        </main>

        <!-- Right: Sidebar -->
        <aside class="w-full lg:w-1/4 space-y-8">
            
            <!-- Instagram Widget -->
            <div class="bg-white rounded-card p-6 shadow-lg border border-gray-100">
                <div class="flex items-center gap-3 mb-6">
                     <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-yellow-400 to-purple-600 text-white flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                     </div>
                     <div>
                         <h3 class="font-bold text-dark">Instagram</h3>
                         <p class="text-xs text-gray-500">@izmiruzmani</p>
                     </div>
                     <a href="https://instagram.com/izmiruzmani" target="_blank" class="ml-auto text-xs font-bold text-primary hover:underline">Takip Et</a>
                </div>
                
                <a href="https://instagram.com/izmiruzmani" target="_blank" class="block relative group overflow-hidden rounded-lg">
                    <!-- Placeholder image - User should replace this with actual screenshot -->
                    <img src="/instagram-preview.jpg" alt="İzmir Uzmanı Instagram" class="w-full h-auto object-cover group-hover:opacity-90 transition" onError="this.src='https://placehold.co/400x400/FaFaFa/999999?text=Instagram+Görseli+Buraya';" />
                </a>
            </div>

            <!-- Categories Widget: Glassmorphism Redesign -->
            <div class="relative group">
                <!-- Background Glow -->
                <div class="absolute -inset-1 bg-gradient-to-r from-primary via-secondary to-primary rounded-card blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                
                <div class="relative bg-white/70 backdrop-blur-xl border border-white/40 rounded-card p-6 shadow-2xl overflow-hidden">
                    <h3 class="text-xl font-black text-dark mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-primary rounded-full"></span>
                        Keşfetmeye Başla
                    </h3>
                    <ul class="space-y-3">
                        {['Yeme-İçme', 'Etkinlikler', 'Gezi', 'Oteller', 'Müzeler'].map(cat => (
                            <li>
                                <a href={`/blog/kategori/${cat}`} class="group/item block py-3 px-4 rounded-xl bg-gray-50/50 hover:bg-primary border border-gray-100 hover:border-primary transition-all duration-300 flex items-center justify-between shadow-sm hover:shadow-primary/20">
                                    <span class="font-bold text-gray-600 group-hover/item:text-white transition-colors">{cat}</span>
                                    <div class="w-8 h-8 rounded-full bg-white text-primary flex items-center justify-center group-hover/item:bg-white/20 group-hover/item:text-white transition-all transform group-hover/item:translate-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M9 5l7 7-7 7" /></svg>
                                    </div>
                                </a>
                            </li>
                        ))}
                    </ul>
                    
                    <!-- Decorative Elements -->
                    <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-primary/5 rounded-full blur-3xl"></div>
                    <div class="absolute -top-10 -left-10 w-32 h-32 bg-secondary/5 rounded-full blur-3xl"></div>
                </div>
            </div>

        </aside>
    </div>

    <!-- Events Slider Section -->
    <section class="max-w-[1400px] mx-auto pt-12 pb-16 px-4 border-t border-gray-100">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-dark flex items-center gap-3">
                <span class="w-2 h-8 bg-secondary rounded-full"></span>
                İzmir Etkinlikleri
            </h2>
            <a href="/etkinlikler" class="px-6 py-2 bg-gray-100 text-dark rounded-full text-sm font-bold hover:bg-primary hover:text-white transition shadow-sm">Tümünü Gör</a>
        </div>

        <div class="flex gap-4 overflow-x-auto snap-x snap-mandatory pb-6 no-scrollbar scroll-smooth">
            {eventPosts.map((post) => {
                const postDate = new Date(post.created_at);
                return (
                    <article class="snap-start shrink-0 w-[70%] sm:w-[45%] md:w-[30%] lg:w-[19.5%] bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col group">
                        <a href={`/blog/${post.slug}`} class="block flex flex-col h-full">
                            <div class="aspect-[3/4] overflow-hidden bg-gray-100 relative">
                                <img src={post.image || `https://picsum.photos/seed/${post.id}/300/400`} class="w-full h-full object-cover group-hover:scale-105 transition duration-500" />
                                <div class="absolute top-2 left-2">
                                    <div class="bg-white/95 backdrop-blur-sm rounded px-2 py-1 text-center shadow-md">
                                        <span class="block text-[8px] font-black text-primary uppercase leading-none">{postDate.toLocaleDateString('tr-TR', { month: 'short' })}</span>
                                        <span class="block text-sm font-black text-dark leading-none mt-1">{postDate.getDate()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 flex flex-col flex-grow">
                                <h3 class="text-xs font-bold text-dark leading-tight group-hover:text-primary transition line-clamp-2 mb-2">{post.title}</h3>
                                <div class="mt-auto flex items-center justify-between pt-2 border-t border-gray-50">
                                    <span class="text-[9px] text-gray-400 font-bold uppercase">{post.category}</span>
                                    <div class="text-primary group-hover:text-secondary transition transform group-hover:translate-x-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </article>
                );
            })}
        </div>
    </section>
</Layout>

<script>
    // Auto Scroll Slider
    const slider = document.getElementById('hero-slider');
    if (slider) {
        let scrollAmount = 0;
        const scrollStep = slider.clientWidth; // Scroll one full width
        const scrollSpeed = 4000; // 4 seconds

        setInterval(() => {
            if (slider.scrollLeft + slider.clientWidth >= slider.scrollWidth) {
                // If at end, scroll back to start smoothly
                 slider.scrollTo({ left: 0, behavior: 'smooth' });
            } else {
                 slider.scrollBy({ left: scrollStep, behavior: 'smooth' });
            }
        }, scrollSpeed);
    }
</script>
