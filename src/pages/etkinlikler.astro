---
import Layout from '../layouts/Layout.astro';
import db from '../lib/db';
import { getWeatherForecast } from '../lib/weather';

const params = Astro.url.searchParams;
const selectedDate = params.get('date') || '';
const now = new Date();
const currentMonth = params.get('m') ? parseInt(params.get('m')!) : now.getMonth();
const currentYear = params.get('y') ? parseInt(params.get('y')!) : now.getFullYear();

const postsResult = await db.execute("SELECT * FROM posts WHERE category = 'Etkinlikler' ORDER BY created_at DESC");
const posts = postsResult.rows as any[];

const popularResult = await db.execute("SELECT * FROM posts ORDER BY created_at DESC LIMIT 5");
const popularPosts = popularResult.rows as any[];

const weatherData = await getWeatherForecast();

// Veritabanındaki gerçek etkinlikler
const allPosts = posts;

function getCalendarDays(m: number, y: number) {
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const firstDay = new Date(y, m, 1).getDay();
    const blanks = firstDay === 0 ? 6 : firstDay - 1;
    const prevMonth = m === 0 ? 11 : m - 1;
    const prevYear = m === 0 ? y - 1 : y;
    const nextMonth = m === 11 ? 0 : m + 1;
    const nextYear = m === 11 ? y + 1 : y;

    return {
        monthName: new Date(y, m).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' }),
        days: Array.from({ length: blanks }).fill(null).concat(Array.from({ length: daysInMonth }).map((_, i) => i + 1)),
        prev: `?m=${prevMonth}&y=${prevYear}`,
        next: `?m=${nextMonth}&y=${nextYear}`
    };
}

const calendar = getCalendarDays(currentMonth, currentYear);
---

<Layout title="Etkinlik Takvimi - İzmir Uzmanı">
    <div class="bg-primary/5 py-16 text-center">
        <h1 class="text-4xl font-bold text-dark mb-4">Etkinlikler</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">İzmir'deki güncel etkinlikler, konserler, sergiler ve daha fazlası. Şehrin nabzını bizimle tutun.</p>
    </div>

    <!-- Container with Sidebar -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Main Content (LEFT) -->
            <main class="flex-grow">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    {allPosts.map((post) => {
                        const postDate = new Date(post.created_at);
                        return (
                            <article class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 border border-gray-100 flex flex-col">
                                <div class="aspect-[3/4] overflow-hidden bg-gray-100 relative">
                                    <img src={post.image || `https://picsum.photos/seed/${post.id}/300/400`} class="w-full h-full object-cover hover:scale-105 transition duration-500" loading="lazy" />
                                    <div class="absolute top-2 left-2">
                                        <div class="bg-white/95 backdrop-blur-sm rounded px-2 py-1 text-center shadow-md">
                                            <span class="block text-[8px] font-black text-primary uppercase leading-none">{postDate.toLocaleDateString('tr-TR', { month: 'short' })}</span>
                                            <span class="block text-sm font-black text-dark leading-none mt-1">{postDate.getDate()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 flex flex-col flex-grow">
                                    <h3 class="text-sm font-bold text-dark leading-tight hover:text-primary transition line-clamp-2 mb-2">{post.title}</h3>
                                    <div class="mt-auto flex items-center justify-between pt-2 border-t border-gray-50">
                                        <span class="text-[9px] text-gray-400 font-bold uppercase">{post.category}</span>
                                        <a href={`/blog/${post.slug}`} class="text-primary hover:text-secondary transition">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                        </a>
                                    </div>
                                </div>
                            </article>
                        );
                    })}
                </div>
            </main>

            <!-- Sidebar (RIGHT) -->
            <aside class="w-full lg:w-1/4 space-y-6">
                
                <!-- 1. TAKVIM -->
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-100">
                        <a href={calendar.prev} class="p-1 hover:bg-gray-200 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M15 19l-7-7 7-7" /></svg>
                        </a>
                        <span class="text-[10px] font-black text-dark uppercase tracking-widest">{calendar.monthName}</span>
                        <a href={calendar.next} class="p-1 hover:bg-gray-200 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M9 5l7 7-7 7" /></svg>
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-7 text-center bg-white py-3 border-b border-gray-50">
                        {['Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct', 'Pz'].map(d => (
                            <span class="text-[10px] font-black text-gray-400">{d}</span>
                        ))}
                    </div>

                    <div class="grid grid-cols-7 gap-px bg-gray-100">
                        {calendar.days.map((day) => {
                            const isToday = day === now.getDate() && currentMonth === now.getMonth() && currentYear === now.getFullYear();
                            const fullDate = day ? `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : '';
                            const isSelected = selectedDate === fullDate;
                            
                            return (
                                <div class="aspect-square relative bg-white">
                                    {day ? (
                                        <button 
                                            class={`w-full h-full flex items-center justify-center text-sm transition-all font-bold
                                            ${isSelected ? 'bg-secondary text-white z-10' : 
                                              isToday ? 'bg-primary text-white z-10' : 
                                              'text-dark hover:bg-secondary hover:text-white'}`}
                                            onclick={`window.location.href = '?date=${fullDate}&m=${currentMonth}&y=${currentYear}'`}
                                        >
                                            {day}
                                        </button>
                                    ) : (
                                        <div class="w-full h-full bg-gray-50/50"></div>
                                    )}
                                </div>
                            )
                        })}
                    </div>
                    <div class="bg-white p-4 text-center border-t border-gray-100">
                        <a href="/etkinlikler" class="text-xs font-bold text-gray-400 hover:text-secondary uppercase tracking-widest transition-colors">Filtreyi Temizle</a>
                    </div>
                </div>

                <!-- 2. HAVA DURUMU -->
                <div class="bg-white rounded-xl shadow-lg p-5 border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-secondary rounded-full"></div>
                        <h3 class="text-xs font-black text-dark uppercase tracking-wider">İzmir Hava Durumu</h3>
                    </div>
                    <div class="flex items-center justify-between bg-primary/5 rounded-xl p-4">
                        <div class="flex items-center gap-4">
                            <div class="text-primary scale-125" set:html={weatherData[0]?.icon}></div>
                            <div>
                                <span class="text-3xl font-black text-dark">{weatherData[0]?.temp}°</span>
                                <p class="text-[10px] text-gray-400 font-bold uppercase">{weatherData[0]?.condition}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. LOGO -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 flex items-center justify-center">
                    <img src="/logo.png" alt="İzmir Uzmanı" class="h-16 w-auto grayscale hover:grayscale-0 transition duration-500 object-contain" />
                </div>

                <!-- 4. POPÜLER GÖNDERILER -->
                <div class="bg-white rounded-xl shadow-lg p-5 border border-gray-100">
                    <h3 class="text-xs font-black text-dark mb-4 border-b border-gray-100 pb-2 uppercase tracking-wider">Popüler İçerikler</h3>
                    <div class="space-y-4">
                        {popularPosts.map((post) => (
                            <a href={`/blog/${post.slug}`} class="flex gap-3 group">
                                <div class="w-14 h-14 rounded-lg bg-gray-100 shrink-0 overflow-hidden shadow-sm">
                                    <img src={post.image || `https://picsum.photos/seed/${post.id}/200/200`} class="w-full h-full object-cover group-hover:scale-110 transition duration-500" />
                                </div>
                                <div class="flex flex-col justify-center">
                                    <h4 class="text-sm font-bold text-dark leading-tight group-hover:text-primary transition line-clamp-2">{post.title}</h4>
                                    <span class="text-[10px] text-gray-400 font-semibold uppercase mt-1">{post.category}</span>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            </aside>

        </div>
    </div>
</Layout>

