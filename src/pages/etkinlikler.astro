---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getWeatherForecast } from '../lib/weather';

const params = Astro.url.searchParams;
const selectedDate = params.get('date') || '';
const now = new Date();
const currentMonth = params.get('m') ? parseInt(params.get('m')!) : now.getMonth();
const currentYear = params.get('y') ? parseInt(params.get('y')!) : now.getFullYear();

const allBlogPosts = await getCollection('blog');
const posts = allBlogPosts
    .filter(p => p.data.category === 'Etkinlikler')
    .map(p => ({ id: p.slug, ...p.data, slug: p.slug }))
    .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

const popularPosts = allBlogPosts
    .map(p => ({ id: p.slug, ...p.data, slug: p.slug }))
    .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
    .slice(0, 5);
const weatherData = await getWeatherForecast();

// Örnek etkinlikler (Veritabanı boşsa veya azsa 5'li satırı tamamlamak için)
const exampleEvents = [
    { id: 9001, title: 'İzmir Filarmoni Konseri', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event1/400/600', created_at: '2026-01-15', slug: 'izmir-filarmoni-konseri' },
    { id: 9002, title: 'Uluslararası Fuar', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event2/400/600', created_at: '2026-01-18', slug: 'uluslararasi-fuar' },
    { id: 9003, title: 'Modern Sanat Sergisi', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event3/400/600', created_at: '2026-01-20', slug: 'sanat-sergisi' },
    { id: 9004, title: 'Caz Festivali 2026', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event4/400/600', created_at: '2026-01-22', slug: 'caz-festivali' },
    { id: 9005, title: 'Tiyatro: Hamlet', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event5/400/600', created_at: '2026-01-25', slug: 'tiyatro-hamlet' },
    { id: 9006, title: 'Rock Konseri', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event6/400/600', created_at: '2026-01-27', slug: 'rock-konseri' },
    { id: 9007, title: 'Kitap Fuarı İzmir', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event7/400/600', created_at: '2026-01-28', slug: 'kitap-fuari' },
    { id: 9008, title: 'Stand-Up Gösterisi', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event8/400/600', created_at: '2026-02-01', slug: 'standup-gosterisi' },
    { id: 9009, title: 'Bale Gösterisi', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event9/400/600', created_at: '2026-02-03', slug: 'bale-gosterisi' },
    { id: 9010, title: 'Film Festivali', category: 'Etkinlikler', image: 'https://picsum.photos/seed/event10/400/600', created_at: '2026-02-05', slug: 'film-festivali' },
];

// Veritabanındaki gerçek etkinliklerle örnekleri birleştiriyoruz (Önce gerçekler, sonra örnekler)
const allPosts = [...posts, ...exampleEvents].slice(0, 10);

function getCalendarDays(m: number, y: number) {
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const firstDay = new Date(y, m, 1).getDay();
    const blanks = firstDay === 0 ? 6 : firstDay - 1;
    const prevMonth = m === 0 ? 11 : m - 1;
    const prevYear = m === 0 ? y - 1 : y;
    const nextMonth = m === 11 ? 0 : m + 1;
    const nextYear = m === 11 ? y + 1 : y;

    return {
        monthName: new Date(y, m).toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' }),
        days: Array.from({ length: blanks }).fill(null).concat(Array.from({ length: daysInMonth }).map((_, i) => i + 1)),
        prev: `?m=${prevMonth}&y=${prevYear}`,
        next: `?m=${nextMonth}&y=${nextYear}`
    };
}

const calendar = getCalendarDays(currentMonth, currentYear);
---

<Layout title="Etkinlik Takvimi - İzmir Uzmanı">
    <div class="bg-primary/5 py-16 text-center">
        <h1 class="text-4xl font-bold text-dark mb-4">Etkinlikler</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">İzmir'deki güncel etkinlikler, konserler, sergiler ve daha fazlası. Şehrin nabzını bizimle tutun.</p>
    </div>

    <!-- Container with Sidebar -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Main Content (LEFT) -->
            <main class="flex-grow">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    {allPosts.map((post) => {
                        const postDate = new Date(post.created_at);
                        return (
                            <article class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 border border-gray-100 flex flex-col">
                                <div class="aspect-[3/4] overflow-hidden bg-gray-100 relative">
                                    <img src={post.image || `https://picsum.photos/seed/${post.id}/300/400`} class="w-full h-full object-cover hover:scale-105 transition duration-500" />
                                    <div class="absolute top-1 left-1">
                                        <div class="bg-white/95 backdrop-blur-sm rounded px-1 py-0.5 text-center shadow-sm">
                                            <span class="block text-[6px] font-black text-primary uppercase leading-none">{postDate.toLocaleDateString('tr-TR', { month: 'short' })}</span>
                                            <span class="block text-[10px] font-black text-dark leading-none mt-0.5">{postDate.getDate()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-1.5 flex flex-col flex-grow">
                                    <h3 class="text-[10px] font-bold text-dark leading-tight hover:text-primary transition line-clamp-2 mb-1">{post.title}</h3>
                                    <div class="mt-auto flex items-center justify-between pt-1 border-t border-gray-50">
                                        <span class="text-[7px] text-gray-400 font-bold uppercase">{post.category}</span>
                                        <a href={`/blog/${post.slug}`} class="text-primary hover:text-secondary transition">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                        </a>
                                    </div>
                                </div>
                            </article>
                        );
                    })}
                </div>
            </main>

            <!-- Sidebar (RIGHT) -->
            <aside class="w-full lg:w-1/4 space-y-6">
                
                <!-- 1. TAKVIM -->
                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-100">
                        <a href={calendar.prev} class="p-1 hover:bg-gray-200 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M15 19l-7-7 7-7" /></svg>
                        </a>
                        <span class="text-[10px] font-black text-dark uppercase tracking-widest">{calendar.monthName}</span>
                        <a href={calendar.next} class="p-1 hover:bg-gray-200 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M9 5l7 7-7 7" /></svg>
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-7 text-center bg-white py-2 border-b border-gray-50">
                        {['Pt', 'Sa', 'Ça', 'Pe', 'Cu', 'Ct', 'Pz'].map(d => (
                            <span class="text-[8px] font-black text-gray-400">{d}</span>
                        ))}
                    </div>

                    <div class="grid grid-cols-7 gap-px bg-gray-100">
                        {calendar.days.map((day) => {
                            const isToday = day === now.getDate() && currentMonth === now.getMonth() && currentYear === now.getFullYear();
                            const fullDate = day ? `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : '';
                            const isSelected = selectedDate === fullDate;
                            
                            return (
                                <div class="aspect-square relative bg-white">
                                    {day ? (
                                        <button 
                                            class={`w-full h-full flex items-center justify-center text-[11px] transition-all font-bold
                                            ${isSelected ? 'bg-secondary text-white z-10' : 
                                              isToday ? 'bg-primary text-white z-10' : 
                                              'text-dark hover:bg-secondary hover:text-white'}`}
                                            onclick={`window.location.href = '?date=${fullDate}&m=${currentMonth}&y=${currentYear}'`}
                                        >
                                            {day}
                                        </button>
                                    ) : (
                                        <div class="w-full h-full bg-gray-50/50"></div>
                                    )}
                                </div>
                            )
                        })}
                    </div>
                    <div class="bg-white p-3 text-center border-t border-gray-100">
                        <a href="/etkinlikler" class="text-[9px] font-bold text-gray-400 hover:text-secondary uppercase tracking-widest transition-colors">Filtreyi Temizle</a>
                    </div>
                </div>

                <!-- 2. HAVA DURUMU -->
                <div class="bg-white rounded-xl shadow-lg p-5 border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-secondary rounded-full"></div>
                        <h3 class="text-xs font-black text-dark uppercase tracking-wider">İzmir Hava Durumu</h3>
                    </div>
                    <div class="flex items-center justify-between bg-primary/5 rounded-xl p-4">
                        <div class="flex items-center gap-4">
                            <div class="text-primary scale-125" set:html={weatherData[0]?.icon}></div>
                            <div>
                                <span class="text-3xl font-black text-dark">{weatherData[0]?.temp}°</span>
                                <p class="text-[10px] text-gray-400 font-bold uppercase">{weatherData[0]?.condition}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. LOGO -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 flex items-center justify-center">
                    <img src="/logo.png" alt="İzmir Uzmanı" class="h-12 w-auto grayscale hover:grayscale-0 transition duration-500" />
                </div>

                <!-- 4. POPÜLER GÖNDERILER -->
                <div class="bg-white rounded-xl shadow-lg p-5 border border-gray-100">
                    <h3 class="text-xs font-black text-dark mb-4 border-b border-gray-100 pb-2 uppercase tracking-wider">Popüler İçerikler</h3>
                    <div class="space-y-4">
                        {popularPosts.map((post) => (
                            <a href={`/blog/${post.slug}`} class="flex gap-3 group">
                                <div class="w-14 h-14 rounded-lg bg-gray-100 shrink-0 overflow-hidden shadow-sm">
                                    <img src={post.image || `https://picsum.photos/seed/${post.id}/200/200`} class="w-full h-full object-cover group-hover:scale-110 transition duration-500" />
                                </div>
                                <div class="flex flex-col justify-center">
                                    <h4 class="text-[11px] font-bold text-dark leading-tight group-hover:text-primary transition line-clamp-2">{post.title}</h4>
                                    <span class="text-[8px] text-gray-400 font-semibold uppercase mt-1">{post.category}</span>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            </aside>

        </div>
    </div>
</Layout>

